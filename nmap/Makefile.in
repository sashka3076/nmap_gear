NMAP_VERSION = 3.10ALPHA9
NMAP_NAME= nmap
NMAP_URL= www.insecure.org/nmap/
NMAP_PLATFORM=@host@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
sbindir = @sbindir@
mandir = @mandir@
srcdir = @srcdir@
nmapdatadir = @datadir@/nmap
deskdir = $(prefix)/share/gnome/apps/Utilities

NBASEDIR=@NBASEDIR@
# CC = @CXX@
CCOPT = 
LIBPCAPDIR = @libpcapdir@
INCLS = -I$(LIBPCAPDIR) 
DEFS = @DEFS@ -DNMAP_VERSION=\"$(NMAP_VERSION)\" -DNMAP_NAME=\"$(NMAP_NAME)\" -DNMAP_URL=\"$(NMAP_URL)\" -DNMAP_PLATFORM=\"$(NMAP_PLATFORM)\" -DNMAPDATADIR=\"$(nmapdatadir)\"
CXXFLAGS = -g -Wall @CXXFLAGS@ $(CCOPT) $(DEFS) $(INCLS)
# CFLAGS = $(CXXFLAGS)
# CFLAGS = -g -Wall $(DEFS) $(INCLS)
STATIC = 
LDFLAGS = @LDFLAGS@ $(STATIC)
LIBS =  @LIBS@ -lpcap
# LIBS =  -lefence @LIBS@ -lpcap
# LIBS =  -lrmalloc @LIBS@ -lpcap
SHTOOL = ./shtool
INSTALL = $(SHTOOL) install 
MAKEDEPEND = @MAKEDEPEND@
RPMTDIR=$(HOME)/rpmdir

TARGET = nmap
TARGETNMAPFE=@TARGETNMAPFE@
INSTALLNMAPFE=@INSTALLNMAPFE@

SRCS = main.cc nmap.cc targets.cc tcpip.cc nmap_error.cc utils.cc idle_scan.cc osscan.cc output.cc scan_engine.cc timing.cc charpool.cc services.cc protocols.cc nmap_rpc.cc portlist.cc NmapOps.cc TargetGroup.cc Target.cc @COMPAT_SRCS@

OBJS = main.o nmap.o targets.o tcpip.o nmap_error.o utils.o idle_scan.o osscan.o output.o scan_engine.o timing.o charpool.o services.o protocols.o nmap_rpc.o portlist.o NmapOps.o TargetGroup.o Target.o @COMPAT_OBJS@

DEPS = nmap.h nmap_error.h targets.h idle_scan.h osscan.h output.h scan_engine.h timing.h tcpip.h utils.h global_structures.h charpool.h services.h protocols.h nmap_rpc.h portlist.h NmapOps.h TargetGroup.h Target.h

all: $(TARGET) $(TARGETNMAPFE)

$(TARGET): $(DEPS) @PCAP_DEPENDS@ $(NBASEDIR)/libnbase.a $(OBJS)
	@echo Compiling nmap
	rm -f $@
	$(CXX) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)

$(LIBPCAPDIR)/libpcap.a: $(LIBPCAPDIR)/Makefile
	@echo Compiling libpcap; cd $(LIBPCAPDIR); $(MAKE)

$(NBASEDIR)/libnbase.a: $(NBASEDIR)/Makefile
	@echo Compiling libnbase;
	cd $(NBASEDIR); $(MAKE)

#$(LIBPCAPDIR)/Makefile:
#	@echo Configuring libpcap; cd $(LIBPCAPDIR); ./configure

nmapfe/nmapfe: 
#	@echo "FAILURES HERE ARE OK -- THEY JUST MEAN YOU CANNOT USE nmapfe"
#	-rm -f nmapfe/Makefile
#	-cd nmapfe; ./configure;
	-cd nmapfe; test -f Makefile && $(MAKE) VERSION=$(NMAP_VERSION) STATIC=$(STATIC);
#	@echo "END OF SECTION WHERE FAILURES ARE OK"

# This target is just for me ... don't you get any ideas --Fyodor
distro: 
	autoconf
	rm -f config.cache
	./configure
	cd $(LIBPCAPDIR) && ./configure
	$(MAKE) clean
	$(MAKE)
	./nmap -h > /dev/null    #Make sure nmap exists
	rm -f docs/nmap.usage.txt	
	./nmap -h > docs/nmap.usage.txt 
	rm -f docs/nmap_manpage.html
# nodepage option is included in man2html because of bug in that program which causes it to
# drop lines if you let it try to delete page breaks
	nroff -man docs/nmap.1 | man2html -nodepage -title 'Nmap network security scanner man page' > docs/nmap_manpage.html
	nroff -man docs/nmap_french.1 | man2html -nodepage -title 'Nmap network security scanner man page (French translation)' > docs/nmap_manpage-fr.html
	nroff -man docs/nmap_german.1 | man2html -nodepage -title 'Nmap network security scanner man page (German translation)' > docs/nmap_manpage-de.html
	nroff -man docs/nmap_italian.1 | man2html -nodepage -title 'Nmap network security scanner man page (Italian translation)' > docs/nmap_manpage-it.html
	nroff -Tlatin1 -man docs/nmap_lithuanian.1 | man2html -nodepage -title 'Nmap network security scanner man page (Lithuanian translation)' > docs/nmap_manpage-lt.html
# We need a content-type for the Lithuanian version
	sr '<HEAD>' '<HEAD><META http-equiv="Content-Type" content="text/html; charset=windows-1257">' docs/nmap_manpage-lt.html
	nroff -man docs/nmap_portuguese.1 | man2html -nodepage -title 'Nmap network security scanner man page (Portuguese translation)' > docs/nmap_manpage-pt.html
	nroff -man docs/nmap_spanish.1 | man2html -nodepage -title 'Nmap network security scanner man page (Spanish translation)' > docs/nmap_manpage-es.html
	rm -rf /usr/tmp/nmap-$(NMAP_VERSION)
	mkdir /usr/tmp/nmap-$(NMAP_VERSION)
# Make the RPM .spec file
	sed -e s/\@VERSION\@/$(NMAP_VERSION)/g nmap.spec.in > nmap-$(NMAP_VERSION)-1.spec
	$(MAKE) clean
	rm -f $(LIBPCAPDIR)/config.cache $(LIBPCAPDIR)/Makefile
	unix2dos README-WIN32
	cp -ra $(SRCS) $(DEPS) nmap-os-fingerprints \
	nmapfe.desktop nmap-services nmap-rpc nmap-protocols \
	configure.in config.h.in nmap_winconfig.h Makefile.in configure \
        $(SHTOOL) install-sh config.guess nmap-$(NMAP_VERSION)-1.spec \
            config.sub INSTALL README-WIN32 COPYING CHANGELOG HACKING \
            /usr/tmp/nmap-$(NMAP_VERSION)
	$(SHTOOL) mkdir /usr/tmp/nmap-$(NMAP_VERSION)/mswin32
	cd mswin32; cp -ra *.[hHcC] *.cc ARPA NET NETINET RPC icon1.ico \
                    ifaddrlist.h lib libpcap-note.txt nmap.dsp \
                    nmap.dsw nmap.rc winip \
                    /usr/tmp/nmap-$(NMAP_VERSION)/mswin32
	$(SHTOOL) mkdir /usr/tmp/nmap-$(NMAP_VERSION)/$(LIBPCAPDIR)

	cd $(LIBPCAPDIR); cp -ra acconfig.h aclocal.m4 arcnet.h bpf \
                          bpf_dump.c bpf_filter.c bpf_image.c CHANGES \
                          config.guess config.h.in config.sub configure \
                          configure.in CREDITS etherent.c ethertype.h FILES \
                          gencode.c gencode.h grammar.c grammar.y inet.c \
                          install-sh INSTALL.txt lbl LICENSE llc.h \
                          Makefile.in mkdep nametoaddr.c net nlpid.h \
                          NMAP_MODIFICATIONS optimize.c pcap.3 pcap-bpf.c \
                          pcap.c pcap-dlpi.c pcap-enet.c pcap.h pcap-int.h \
                          pcap-linux.c pcap-namedb.h pcap-nit.c pcap-nit.h \
                          pcap-null.c pcap-pf.c pcap-pf.h pcap-snit.c \
                          pcap-snoop.c ppp.h README README.aix README.linux \
                          README.tru64 savefile.c scanner.c scanner.l sll.h \
                          SUNOS4 TODO tokdefs.h VERSION \
                          /usr/tmp/nmap-$(NMAP_VERSION)/$(LIBPCAPDIR)
	$(SHTOOL) mkdir /usr/tmp/nmap-$(NMAP_VERSION)/docs
	cd docs; cp -ra README copying.html nmap-fingerprinting-article.txt \
                    nmap.deprecated.txt nmap.usage.txt nmap_doc.html \
                    nmap_manpage-de.html nmap_manpage-es.html \
                    nmap_manpage-fr.html nmap_manpage-it.html \
                    nmap_manpage-lt.html nmap_manpage-pt.html \
                    nmap_manpage-ru.html nmap_manpage.html \
                    nmap.1 nmapfe.1 nmap_french.1 nmap_german.1 \
                    nmap_italian.1 nmap_lithuanian.1 nmap_portuguese.1 \
                    nmap_spanish.1 xnmap.1 nmap.dtd \
                    /usr/tmp/nmap-$(NMAP_VERSION)/docs
	$(SHTOOL) mkdir /usr/tmp/nmap-$(NMAP_VERSION)/nmapfe
	cd nmapfe; cp -ra Makefile.in aclocal.m4 configure configure.in \
	              nmapfe.c nmapfe.h nmapfe_sig.c nmapfe_sig.h \
	              nmapfe_error.c nmapfe_error.h NmapFE.dsp nmapfe.dsw \
	              /usr/tmp/nmap-$(NMAP_VERSION)/nmapfe
	$(SHTOOL) mkdir /usr/tmp/nmap-$(NMAP_VERSION)/nbase
	cd $(NBASEDIR); cp -ra Makefile.in aclocal.m4 configlocal.m4 \
                        configure configure.in nbase_config.h.in \
                        *.c *.h CHANGELOG /usr/tmp/nmap-$(NMAP_VERSION)/nbase

	rm -f /usr/tmp/nmap-$(NMAP_VERSION)/nbase/nbase_config.h 
# Kill the CVS crap
	find /usr/tmp/nmap-$(NMAP_VERSION) -type d -name CVS | xargs rm -rf
	find /usr/tmp/nmap-$(NMAP_VERSION) -exec chmod go=u-w '{}' \;
	cd /usr/tmp; \
	tar czf nmap-$(NMAP_VERSION).tgz nmap-$(NMAP_VERSION)
# Make the actual RPM
	rpm -ta /usr/tmp/nmap-$(NMAP_VERSION).tgz
	cp -f $(RPMTDIR)/RPMS/i386/nmap-$(NMAP_VERSION)-1.i386.rpm /usr/tmp
	cp -f $(RPMTDIR)/RPMS/i386/nmap-frontend-$(NMAP_VERSION)-1.i386.rpm /usr/tmp
	cp -f $(RPMTDIR)/SRPMS/nmap-$(NMAP_VERSION)-1.src.rpm /usr/tmp
	rm -rf /usr/tmp/nmap-$(NMAP_VERSION)

# Update the web site
web:
	test x$(wroot) != x
	cp -a CHANGELOG HACKING COPYING INSTALL nmap-os-fingerprints nmap-protocols nmap-services nmap-rpc README-WIN32 $(wroot)/nmap/data
	cd docs && cp -a nmap_manpage*.html nmap.usage.txt nmap.dtd $(wroot)/nmap/data/
	find $(wroot)/nmap/data/ -type f -exec chmod 644 '{}' \;

# For distributing the binary
static: 	
	cd $(LIBPCAPDIR); $(MAKE)
	$(CC) $(CXXFLAGS) -static $(LDFLAGS) -o nmap.linux.bin  $(SRCS) $(LIBS)
	strip nmap.linux.bin

clean: @PCAP_CLEAN@ nmapfe_clean nbase_clean my_clean

my_clean:
	rm -f $(OBJS) $(TARGET) config.cache
pcap_clean:
	cd $(LIBPCAPDIR); $(MAKE) clean
nmapfe_clean:
	cd nmapfe; $(MAKE) clean
nbase_clean:
	cd $(NBASEDIR); $(MAKE) clean
pcap_dist_clean:
	cd $(LIBPCAPDIR); $(MAKE) distclean

distclean: my_clean my_distclean @PCAP_DIST_CLEAN@
my_distclean:
	rm -f Makefile Makefile.bak config.h stamp-h stamp-h.in \
	         config.cache config.log config.status

depend:
	$(MAKEDEPEND) $(INCLS) -s "# DO NOT DELETE" -- $(DEFS) -- $(SRCS)

install-nmap: $(TARGET)
	$(SHTOOL) mkdir -f -p -m 755 $(bindir) $(mandir)/man1 $(nmapdatadir) $(deskdir)
	$(INSTALL) -c -m 755 nmap $(bindir)/nmap
	$(INSTALL) -c -m 644 docs/$(TARGET).1 $(mandir)/man1/$(TARGET).1
	$(INSTALL) -c -m 644 nmap-os-fingerprints  $(nmapdatadir)/nmap-os-fingerprints
	$(INSTALL) -c -m 644 nmap-services  $(nmapdatadir)/nmap-services
	$(INSTALL) -c -m 644 nmap-protocols  $(nmapdatadir)/nmap-protocols
	$(INSTALL) -c -m 644 nmap-rpc  $(nmapdatadir)/nmap-rpc

install-nmapfe: $(TARGETNMAPFE)
	$(SHTOOL) mkdir -f -p -m 755 $(bindir) $(mandir)/man1 $(nmapdatadir) $(deskdir)
	@echo "If the next command fails -- you cannot use the X front end"
	-test -f nmapfe/nmapfe && $(INSTALL) -c -m 755 nmapfe/nmapfe $(bindir)/nmapfe && rm -f $(bindir)/xnmap && $(SHTOOL) mkln -f -s $(bindir)/nmapfe $(bindir)/xnmap && $(INSTALL) -c -m 644 nmapfe.desktop $(deskdir)/nmapfe.desktop && $(INSTALL) -c -m 644 docs/nmapfe.1 $(mandir)/man1/nmapfe.1 && $(INSTALL) -c -m 644 docs/xnmap.1 $(mandir)/man1/xnmap.1

install: install-nmap $(INSTALLNMAPFE)

uninstall:
	rm -f $(bindir)/$(TARGET) $(bindir)/nmapfe $(bindir)/xnmap
	rm -f $(deskdir)/nmapfe.desktop $(mandir)/man1/nmapfe.1
	rm -f $(mandir)/man1/xnmap.1 $(mandir)/man1/nmap.1
	rm -rf $(nmapdatadir) 
	rm -f $(bindir)/$(TARGET)

${srcdir}/configure: configure.in 
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in acconfig.h \
	config.h.top config.h.bot
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

# DO NOT DELETE -- Needed by makedepend







